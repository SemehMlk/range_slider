import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.data.domain.*;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.data.jpa.domain.Specification;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.catchThrowable;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.*;

public class MessagesServiceTest {

    @Mock
    private CanonicalMessageRepository canonicalMessageRepository;

    @Mock
    private MessageMapper messageMapper;

    @Mock
    private MessageSpecificationBuilder messageSpecificationBuilder;

    @InjectMocks
    private MessagesService messagesService;

    @BeforeEach
    public void setUp() {
        MockitoAnnotations.openMocks(this);
    }

    @Test
    public void getAllMessages_ShouldThrowInvalidRequestException_WhenPageNumberIsInvalid() {
        int pageNumber = -1;
        int pageSize = 10;
        String sortBy = "id";
        String order = "asc";
        ApiSearchRequestDto apiSearchRequest = new ApiSearchRequestDto();

        Throwable thrown = catchThrowable(() -> {
            messagesService.getAllMessages(pageNumber, pageSize, sortBy, order, apiSearchRequest);
        });

        assertThat(thrown).isInstanceOf(InvalidRequestException.class);

        InvalidRequestException exception = (InvalidRequestException) thrown;
        assertThat(exception.getErrors()).hasSize(1);
        assertThat(exception.getErrors().get(0).getMessage()).isEqualTo("Page number must be non-negative.");
        assertThat(exception.getStatus()).isEqualTo(HttpStatus.BAD_REQUEST);
    }

    @Test
    public void getAllMessages_ShouldThrowInvalidRequestException_WhenPageSizeIsInvalid() {
        int pageNumber = 0;
        int pageSize = -1;
        String sortBy = "id";
        String order = "asc";
        ApiSearchRequestDto apiSearchRequest = new ApiSearchRequestDto();

        Throwable thrown = catchThrowable(() -> {
            messagesService.getAllMessages(pageNumber, pageSize, sortBy, order, apiSearchRequest);
        });

        assertThat(thrown).isInstanceOf(InvalidRequestException.class);

        InvalidRequestException exception = (InvalidRequestException) thrown;
        assertThat(exception.getErrors()).hasSize(1);
        assertThat(exception.getErrors().get(0).getMessage()).isEqualTo("Page size must be greater than zero.");
        assertThat(exception.getStatus()).isEqualTo(HttpStatus.BAD_REQUEST);
    }

    @Test
    public void getAllMessages_ShouldReturnMessages_WhenRequestIsValid() {
        int pageNumber = 0;
        int pageSize = 10;
        String sortBy = "id";
        String order = "asc";
        ApiSearchRequestDto apiSearchRequest = new ApiSearchRequestDto();

        Specification<KemmCanonicalMessage> spec = (root, query, criteriaBuilder) -> criteriaBuilder.conjunction();
        Sort.Direction direction = Sort.Direction.fromString(order);
        Pageable pageable = PageRequest.of(pageNumber, pageSize, Sort.by(direction, sortBy));
        KemmCanonicalMessage message = new KemmCanonicalMessage();
        MessageDto messageDto = new MessageDto();
        Page<KemmCanonicalMessage> messagePage = new PageImpl<>(Collections.singletonList(message));

        when(messageSpecificationBuilder.buildSpecification(any(ApiSearchRequestDto.class))).thenReturn(spec);
        when(canonicalMessageRepository.findAll(any(Specification.class), eq(pageable))).thenReturn(messagePage);
        when(messageMapper.toDto(any(KemmCanonicalMessage.class))).thenReturn(messageDto);

        ResponseEntity<MessagesPageDto> response = messagesService.getAllMessages(pageNumber, pageSize, sortBy, order, apiSearchRequest);

        assertThat(response).isNotNull();
        assertThat(response.getStatusCodeValue()).isEqualTo(200);
        MessagesPageDto body = response.getBody();
        assertThat(body).isNotNull();
        assertThat(body.getElements()).hasSize(1);
        assertThat(body.getTotalElements()).isEqualTo(1);
        assertThat(body.getCurrentPageNumber()).isEqualTo(pageNumber);
        assertThat(body.getCurrentPageSize()).isEqualTo(pageSize);
        assertThat(body.getTotalPages()).isEqualTo(1);

        verify(messageSpecificationBuilder).buildSpecification(apiSearchRequest);
        verify(canonicalMessageRepository).findAll(spec, pageable);
        verify(messageMapper).toDto(message);
    }

    @Test
    public void validateRequest_ShouldReturnErrors_WhenPageNumberIsInvalid() {
        Integer pageNumber = -1;
        Integer pageSize = 10;

        List<ErrorObjectDto> errors = messagesService.validateRequest(pageNumber, pageSize);

        assertThat(errors).hasSize(1);
        assertThat(errors.get(0).getMessage()).isEqualTo("Page number must be non-negative.");
    }

    @Test
    public void validateRequest_ShouldReturnErrors_WhenPageSizeIsInvalid() {
        Integer pageNumber = 0;
        Integer pageSize = -1;

        List<ErrorObjectDto> errors = messagesService.validateRequest(pageNumber, pageSize);

        assertThat(errors).hasSize(1);
        assertThat(errors.get(0).getMessage()).isEqualTo("Page size must be greater than zero.");
    }

    @Test
    public void validateRequest_ShouldReturnNoErrors_WhenParametersAreValid() {
        Integer pageNumber = 0;
        Integer pageSize = 10;

        List<ErrorObjectDto> errors = messagesService.validateRequest(pageNumber, pageSize);

        assertThat(errors).isEmpty();
    }
}
