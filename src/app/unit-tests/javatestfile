import org.mockito.ArgumentCaptor;
import org.mockito.Mockito;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.verify;
import static org.assertj.core.api.Assertions.assertThat;

import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import java.time.OffsetDateTime;

public class MessageSpecificationBuilderTest {

    @Test
    public void testCreateSpecificationElapsedTimeWithCapturedArguments() {
        // Arrange
        ApiSearchCriteriaDto criteria = MessageTestUtils.createInLapseTimeCriteria(ApiSearchableFieldDto.FieldEnum.CREATION_DATE);

        ApiSearchRequestDto request = new ApiSearchRequestDto();
        request.setLogicOperator(ApiLogicSearchOperatorDto.AND);
        request.setCriteria(List.of(criteria));

        Specification<KemmCanonicalMessage> spec = MessageSpecificationBuilder.buildSpecification(request);

        // Mocking
        Root<KemmCanonicalMessage> root = Mockito.mock(Root.class);
        CriteriaQuery<?> query = Mockito.mock(CriteriaQuery.class);
        CriteriaBuilder cb = Mockito.mock(CriteriaBuilder.class);

        // Appliquer la spécification
        spec.toPredicate(root, query, cb);

        // Capturer les arguments passés à CriteriaBuilder.between
        ArgumentCaptor<OffsetDateTime> lowerBoundCaptor = ArgumentCaptor.forClass(OffsetDateTime.class);
        ArgumentCaptor<OffsetDateTime> upperBoundCaptor = ArgumentCaptor.forClass(OffsetDateTime.class);

        // Vérifier que between est bien appelé avec les bons arguments
        verify(cb).between(
            eq(root.get("creationDate")), // Utilisez eq avec le type correct ici
            lowerBoundCaptor.capture(),
            upperBoundCaptor.capture()
        );

        // Assert sur les arguments capturés
        OffsetDateTime lowerBound = lowerBoundCaptor.getValue();
        OffsetDateTime upperBound = upperBoundCaptor.getValue();

        assertThat(lowerBound).isNotNull();
        assertThat(upperBound).isNotNull();

        // Ajoutez ici les assertions supplémentaires sur les valeurs capturées
    }
}
