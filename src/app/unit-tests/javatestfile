import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.MockitoAnnotations;
import org.springframework.data.jpa.domain.Specification;

import java.time.OffsetDateTime;
import java.time.ZoneOffset;
import java.util.Collections;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.catchThrowable;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

public class MessageSpecificationBuilderTest {

    @BeforeEach
    public void setUp() {
        MockitoAnnotations.openMocks(this);
    }

    @Test
    public void buildSpecification_ShouldThrowInvalidRequestException_WhenCriteriaIsInvalid() {
        ApiSearchRequestDto request = new ApiSearchRequestDto();
        request.setCriteria(Collections.emptyList()); // Invalid criteria

        Throwable thrown = catchThrowable(() -> {
            MessageSpecificationBuilder.buildSpecification(request);
        });

        assertThat(thrown).isInstanceOf(InvalidRequestException.class);
        InvalidRequestException exception = (InvalidRequestException) thrown;
        assertThat(exception.getErrors()).hasSize(1);
        assertThat(exception.getErrors().get(0).getMessage()).isEqualTo("Bad search request.");
        assertThat(exception.getStatus()).isEqualTo(HttpStatus.BAD_REQUEST);
    }

    @Test
    public void buildSpecification_ShouldReturnSpecification_WhenCriteriaIsValid() {
        ApiSearchCriteriaDto criteria = new ApiSearchCriteriaDto();
        criteria.setCriteriaType("EQUAL_DATE");
        criteria.setSearchField(new ApiSearchableFieldDto());
        criteria.getSearchField().setField("CREATION_DATE");
        criteria.setSearchDateValue(OffsetDateTime.now(ZoneOffset.UTC).toLocalDate());

        ApiSearchRequestDto request = new ApiSearchRequestDto();
        request.setCriteria(List.of(criteria));
        request.setLogicOperator(ApiLogicSearchOperatorDto.AND);

        Specification<KemmCanonicalMessage> spec = MessageSpecificationBuilder.buildSpecification(request);

        assertThat(spec).isNotNull();
    }

    @Test
    public void createDateTimeRangeSpecification_ShouldReturnCorrectSpecification() {
        ApiDateTimeRangeCriteriaDto criteria = new ApiDateTimeRangeCriteriaDto();
        criteria.setSearchField(new ApiSearchableFieldDto());
        criteria.getSearchField().setField("CREATION_DATE");
        criteria.setMinDate(OffsetDateTime.now(ZoneOffset.UTC));
        criteria.setMaxDate(OffsetDateTime.now(ZoneOffset.UTC).plusDays(1));

        Specification<KemmCanonicalMessage> spec = MessageSpecificationBuilder.createDateTimeRangeSpecification(criteria);

        assertThat(spec).isNotNull();
    }

    @Test
    public void createEqualDateSpecification_ShouldReturnCorrectSpecification() {
        ApiEqualDateCriteriaDto criteria = new ApiEqualDateCriteriaDto();
        criteria.setSearchField(new ApiSearchableFieldDto());
        criteria.getSearchField().setField("CREATION_DATE");
        criteria.setSearchDateValue(OffsetDateTime.now(ZoneOffset.UTC).toLocalDate());

        Specification<KemmCanonicalMessage> spec = MessageSpecificationBuilder.createEqualDateSpecification(criteria);

        assertThat(spec).isNotNull();
    }

    @Test
    public void createInLastTimeLapseSpecification_ShouldReturnCorrectSpecification() {
        ApiInLastTimeLapseCriteriaDto criteria = new ApiInLastTimeLapseCriteriaDto();
        criteria.setSearchField(new ApiSearchableFieldDto());
        criteria.getSearchField().setField("CREATION_DATE");
        criteria.setTimeLapse(24);
        criteria.setTimeUnit(ApiTimeUnitDto.HOUR);

        Specification<KemmCanonicalMessage> spec = MessageSpecificationBuilder.createInLastTimeLapseSpecification(criteria);

        assertThat(spec).isNotNull();
    }

    @Test
    public void createTextSpecification_ShouldReturnCorrectSpecification() {
        ApiTextCriteriaDto criteria = new ApiTextCriteriaDto();
        criteria.setSearchField(new ApiSearchableFieldDto());
        criteria.getSearchField().setField("MESSAGE_CONTENT");
        criteria.setSearchText("test");

        Specification<KemmCanonicalMessage> spec = MessageSpecificationBuilder.createTextSpecification(criteria);

        assertThat(spec).isNotNull();
    }

    @Test
    public void createRegexSpecification_ShouldReturnCorrectSpecification() {
        ApiRegexCriteriaDto criteria = new ApiRegexCriteriaDto();
        criteria.setSearchField(new ApiSearchableFieldDto());
        criteria.getSearchField().setField("MESSAGE_CONTENT");
        criteria.setSearchValue("test.*");

        Specification<KemmCanonicalMessage> spec = MessageSpecificationBuilder.createRegexSpecification(criteria);

        assertThat(spec).isNotNull();
    }
}
