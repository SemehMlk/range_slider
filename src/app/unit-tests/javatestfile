import { Component, OnInit } from '@angular/core';
import { FilterCriteriaService } from './services/filter-criteria.service';
import { FilterCriteria } from './models/filter-criteria';
import { Subscription } from 'rxjs';

@Component({
  selector: 'flows-filter-sidebar',
  templateUrl: './flows-filter-sidebar.component.html',
  styleUrls: ['./flows-filter-sidebar.component.scss']
})
export class FlowsFilterSidebarComponent implements OnInit {
  public criterias: FilterCriteria[] = [];
  private subscription: Subscription;

  constructor(private filterCriteriaService: FilterCriteriaService) {}

  ngOnInit(): void {
    // S'abonner aux changements des critères
    this.subscription = this.filterCriteriaService.criterias$.subscribe(
      (criterias) => {
        this.criterias = criterias;
      }
    );
  }

  // Ajouter un nouveau critère
  public addFilter(field: any): void {
    const newCriteria: FilterCriteria = {
      field,
      operator: 'EQUAL',
      value: null,
      fieldType: field.fieldType,
      isEditable: true,
    };

    this.filterCriteriaService.addCriteria(newCriteria);
  }

  // Mettre à jour un critère après modification
  public updateCriteriaValue(criteria: FilterCriteria, value: any, index: number): void {
    criteria.value = value;
    this.filterCriteriaService.updateCriteria(criteria, index);
  }

  // Méthode pour gérer la perte de focus d'un critère
  public onFilterFocusOut(index: number): void {
    const criteria = this.criterias[index];

    // Si le critère est valide, le rendre non éditable
    if (this.isFilterValid(criteria)) {
      criteria.isEditable = false;
      this.filterCriteriaService.updateCriteria(criteria, index);
    }
  }

  // Validation d'un critère
  public isFilterValid(criteria: FilterCriteria): boolean {
    switch (criteria.operator) {
      case 'BETWEEN':
        return criteria.value?.min != null && criteria.value?.max != null;
      case 'IN':
      case 'NOT_IN':
        return Array.isArray(criteria.value) && criteria.value.length > 0;
      default:
        return criteria.value != null;
    }
  }

  // Supprimer un critère
  public removeFilter(index: number): void {
    this.filterCriteriaService.removeCriteria(index);
  }

  // Rendre un critère éditable
  public makeFilterEditable(index: number): void {
    const criteria = this.criterias[index];
    criteria.isEditable = true;
    this.filterCriteriaService.updateCriteria(criteria, index);
  }

  // Supprimer tous les critères
  public removeAllFilters(): void {
    this.filterCriteriaService.resetCriterias();
  }

  ngOnDestroy(): void {
    if (this.subscription) {
      this.subscription.unsubscribe();
    }
  }
}
